@page "/edit-character"
@rendermode InteractiveServer

@inject CharacterService _characterService

@using CharacterCreator.ClassLibrary.Main
@using System.Text.Json
@using CharacterCreator.Frontend.Services

<h3>Edit Character</h3>

<div class="character-select mb-3">
    <label>Select a character:</label>
    <select value="@selectedCharacter" @onchange="OnCharacterChanged" class="form-control d-inline-block" style="max-width: 300px;">
        <option value="">-- New Character --</option>
        @foreach (var name in availableCharacterNames)
        {
            <option value="@name">@name</option>
        }
    </select>
</div>

@if (character == null)
{
    <p>No character loaded. Enter a name and click "Load" to begin.</p>
}
else
{
    <div class="dnd-character-sheet">
        <!-- Header Component -->
        <CharacterHeader Character="character" />

        <!-- Abilities Row -->
        <div class="abilities-row">
            <AbilityInput 
            Label="Strength" Score="@character.Strength" Modifier="@character.StrengthModifier" ScoreChanged="@(value => character.Strength = value)" />
            <AbilityInput 
            Label="Dexterity" Score="@character.Dexterity" Modifier="@character.DexterityModifier" ScoreChanged="@(value => character.Dexterity = value)" />
            <AbilityInput 
            Label="Constitution" Score="@character.Constitution" Modifier="@character.ConstitutionModifier" ScoreChanged="@(value => character.Constitution = value)" />
            <AbilityInput 
            Label="Intelligence" Score="@character.Intelligence" Modifier="@character.IntelligenceModifier" ScoreChanged="@(value => character.Intelligence = value)" />
            <AbilityInput 
            Label="Wisdom" Score="@character.Wisdom" Modifier="@character.WisdomModifier" ScoreChanged="@(value => character.Wisdom = value)" />
            <AbilityInput 
            Label="Charisma" Score="@character.Charisma" Modifier="@character.CharismaModifier" ScoreChanged="@(value => character.Charisma = value)" />
        </div>

        <!-- Save Button -->
        <button class="btn btn-primary mt-3" @onclick="SaveCharacter">Save</button>
    </div>
}

@code {
    // List of available character names populated from the API.
    private List<string> availableCharacterNames = new List<string>();

    // Holds the currently selected character name from the dropdown.
    private string selectedCharacter = "";

    // The current character being edited.
    private Character? character;

    protected override async Task OnInitializedAsync()
    {
        // Retrieve available character names from the API.
        availableCharacterNames = await _characterService.GetAvailableCharactersAsync();
    }

    // Called when the selection in the dropdown changes.
    private async Task OnCharacterChanged(ChangeEventArgs e)
    {
        selectedCharacter = e.Value?.ToString() ?? "";
        await LoadCharacter();
    }

    private async Task LoadCharacter()
    {
        if (!string.IsNullOrWhiteSpace(selectedCharacter))
        {
            // Load the selected character from the API.
            character = await _characterService.GetCharacterAsync(selectedCharacter);
        }
        else
        {
            // If "-- New Character --" is selected, initialize a new character.
            character = new Character
                {
                    Name = "",
                    CharacterClass = "",
                    Species = "",
                    Level = 0,
                    Strength = 0,
                    Dexterity = 0,
                    Constitution = 0,
                    Intelligence = 0,
                    Wisdom = 0,
                    Charisma = 0
                };
        }
    }

    private async Task SaveCharacter(MouseEventArgs e)
    {
        if (character != null)
        {
            if (string.IsNullOrEmpty(character.Name))
            {
                return;
            }

            var saved = await _characterService.SaveCharacterAsync(character);
            if (saved != null)
            {
                character = saved;

                // Refresh the available character names list.
                availableCharacterNames = await _characterService.GetAvailableCharactersAsync();

                // Optionally update the selected character to match the saved character.
                selectedCharacter = character.Name;
            }
        }
    }

    // Compute the attribute modifier using the standard D&D formula.
    private int GetModifier(int score)
    {
        return (int)Math.Floor((score - 10) / 2.0);
    }
}