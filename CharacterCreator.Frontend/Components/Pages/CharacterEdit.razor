@page "/edit-character"
@rendermode InteractiveServer

@using CharacterCreator.ClassLibrary.Main
@using System.Text.Json

<h3>Edit Character</h3>

@if (character == null)
{
    <p>Loading character data...</p>
}
else
{
    <div class="dnd-character-sheet">
        <!-- Header Component -->
        <CharacterHeader Character="character" />

        <!-- Abilities Row -->
        <div class="abilities-row">
            <AbilityInput Label="Strength" Score="@character.Strength" ScoreChanged="@(value => character.Strength = value)" />
            <AbilityInput Label="Dexterity" Score="@character.Dexterity" ScoreChanged="@(value => character.Dexterity = value)" />
            <AbilityInput Label="Constitution" Score="@character.Constitution" ScoreChanged="@(value => character.Constitution = value)" />
            <AbilityInput Label="Intelligence" Score="@character.Intelligence" ScoreChanged="@(value => character.Intelligence = value)" />
            <AbilityInput Label="Wisdom" Score="@character.Wisdom" ScoreChanged="@(value => character.Wisdom = value)" />
            <AbilityInput Label="Charisma" Score="@character.Charisma" ScoreChanged="@(value => character.Charisma = value)" />
        </div>

        <!-- Save Button -->
        <button class="btn btn-primary mt-3" @onclick="SaveCharacter">Save</button>
    </div>
}

@code {
    // The character will either be loaded from a JSON file or initialized with empty values.
    private Character character;

    protected override async Task OnInitializedAsync()
    {
        // Check if a saved JSON file exists
        if (File.Exists("character.json"))
        {
            try
            {
                var json = await File.ReadAllTextAsync("character.json");
                // Attempt to deserialize the JSON into a Character object
                character = JsonSerializer.Deserialize<Character>(json);
            }
            catch (Exception)
            {
                // If there's an error during deserialization, fallback to an empty character.
                character = null;
            }
        }

        // If no saved character was found or deserialization failed, initialize a new, empty character.
        if (character == null)
        {
            character = new();
        }
    }

    private async Task SaveCharacter(MouseEventArgs e)
    {
        // Create JSON options for better readability (optional)
        var options = new JsonSerializerOptions { WriteIndented = true };
        // Serialize the character object to a JSON string
        var json = JsonSerializer.Serialize(character, options);

        // Save the JSON string to a file on the server (adjust the file path as necessary)
        await File.WriteAllTextAsync("character.json", json);
    }

    // Compute the attribute modifier using the standard D&D formula.
    private int GetModifier(int score)
    {
        return (int)Math.Floor((score - 10) / 2.0);
    }
}